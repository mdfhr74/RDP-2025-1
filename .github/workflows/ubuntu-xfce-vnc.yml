name: Ubuntu XFCE VNC

on: [workflow_dispatch]

jobs:
  start-desktop:
    runs-on: ubuntu-latest

    steps:
    - name: Set up XFCE and VNC
      run: |
        sudo apt update
        sudo apt install -y xfce4 xfce4-goodies tightvncserver firefox
        vncserver :1
        vncserver -kill :1
        mkdir -p ~/.vnc
        echo "#!/bin/bash\nxrdb $HOME/.Xresources\nstartxfce4 &" > ~/.vnc/xstartup
        chmod +x ~/.vnc/xstartup
        echo "Lion232" | vncpasswd -f > ~/.vnc/passwd
        chmod 600 ~/.vnc/passwd
        vncserver :1

    - name: Setup ngrok tunnel
      run: |
        curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
        echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
        sudo apt update && sudo apt install -y ngrok
        ngrok config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
        nohup ngrok tcp 5901 &

    - name: Prevent idle timeout
      run: |
        while true; do echo "Running..."; sleep 300; done
